#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2
VENDOR_DIR="$BUILD_DIR/vendor"

mkdir -p $BUILD_DIR
mkdir -p $CACHE_DIR

echo "-----> Install ImageMagick"

IMAGE_MAGICK_VERSION="${IMAGE_MAGICK_VERSION:-6.9.11-0}"
LIBWEBP_VERSION="1.0.3"

IMAGE_MAGICK_INSTALL_DIR="$VENDOR_DIR/imagemagick"
IMAGE_MAGICK_CACHE_FILE="$CACHE_DIR/imagemagick-${IMAGE_MAGICK_VERSION}-${LIBWEBP_VERSION}-compiled.tar.gz"

IMAGICK_VERSION="${IMAGICK_VERSION:-3.4.3}"
IMAGICK_INSTALL_DIR="$VENDOR_DIR/imagick"
PHP_EXT_DIR=$(php-config --extension-dir)
IMAGICK_INSTALL_FILE="$PHP_EXT_DIR/imagick.so"
IMAGICK_CACHE_FILE="imagick.so"
pwd
echo
ls
echo
ls ..
echo "-----> Extracting cached Imagick $IMAGICK_CACHE_FILE => $VENDOR_DIR"
ls -l
echo
chmod 700 imagick.so
ls -l
echo
cp $IMAGICK_CACHE_FILE $IMAGICK_INSTALL_FILE
